<!DOCTYPE html>

<html>
<head>
  <title>library.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="base.html">
                base.coffee
              </a>
            
              
              <a class="source" href="janus.coffee.html">
                janus.coffee.md
              </a>
            
              
              <a class="source" href="library.html">
                library.coffee
              </a>
            
              
              <a class="source" href="collection.html">
                collection.coffee
              </a>
            
              
              <a class="source" href="model.html">
                model.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>library.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The <strong>Library</strong> is a resource tracker. One can register classes or instances
against it, and recall them via description. This enables flexibility around
differing implementations of some functional task, such as rendering a model
in a different context or making a semantically isomorphic network request
from various environments, without being dependent on direct class reference.</p>
<p>Note that in order to performantly track classtypes, registering a class with
a library will result in a reference id being stored away upon it.</p>
<p>In a cute piece of metaphor-based naming, the internal tracking object is
known as a bookcase, the subdivisions therein (first by class then by
context) are called shelves, and the actual stored objects are books.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util = require(<span class="string">'util'</span>)

<span class="class"><span class="keyword">class</span> <span class="title">Library</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Initializes a <code>Library</code>. Libraries can be initialized with some options:</p>
<ul>
<li><code>handler</code>: Defines what to do with a registered book when it is
retrieved. By default, it assumes books are constructors with which a
new instance should be initialized with the target object as a parameter,
and returned to the user.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@options</span> = {}) -&gt;
    <span class="keyword">this</span>.bookcase = {}

    <span class="keyword">this</span>.options.handler ?= (obj, book) -&gt; <span class="keyword">new</span> book(obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Registers a book with the <code>Library</code>. It takes some fixed parameters:</p>
<ol>
<li><code>klass</code>: The class of target objects that ought to be matched with this
book. The library will match contravariants of the given type.</li>
<li><code>book</code>: The actual entity to return to the user upon match. By default,
this is assumed to be a constructor (see <code>handler</code> option in the
constructor), but it can be anything.</li>
<li><code>context</code>: <em>Optional</em>: A string denoting what sort of match we&#39;re looking
for. This can be anything; recommended usages include &#39;client&#39; vs
&#39;server&#39;, &#39;default&#39; vs &#39;edit&#39;, etc.</li>
<li><code>options</code>: <em>Optional</em>: A hash with any of the following additional
options:<ul>
<li><code>priority</code>: A positive integer denoting the priority of this
registration. The higher the value, the higher the priority.</li>
<li><code>attributes</code>: An additional set of descriptive attributes in hash
form. This can be arbitrarily nested, but values will be compared with
strict equality.</li>
<li><code>rejector</code>: After a basic match, the <code>rejector</code> is called and passed in
the target object. Returning <code>true</code> will fail the match.</li>
<li><code>acceptor</code>: After a basic match, the <code>acceptor</code> is called and passed in
the target object. Returning anything but <code>true</code> will fail the match.</li>
</ul>
</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  register: (klass, book, context = <span class="string">'default'</span>, options = {}) -&gt;
    bookId = Library._classId(klass)

    classShelf = <span class="keyword">this</span>.bookcase[bookId] ?= {}
    contextShelf = classShelf[context] ?= []

    contextShelf.push(
      book: book
      options: options
    )

    contextShelf.sort((a, b) -&gt; (b.options.priority ? <span class="number">0</span>) - (a.options.priority ? <span class="number">0</span>)) <span class="keyword">if</span> options.priority?

    book</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The big show. Given some object, returns the first match in the Library.
Takes the target <code>obj</code>, and optionally the string <code>context</code> and an
<code>attributes</code> hash.</p>
<p><strong>Returns</strong> a registered book, processed by the Library&#39;s <code>handler</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: (obj, context = <span class="string">'default'</span>, attributes = {}) -&gt;
    result =
      <span class="keyword">this</span>._get(obj, obj.constructor, context, attributes) ?
      <span class="keyword">this</span>._get(obj, obj.constructor, <span class="string">'default'</span>, attributes)
    <span class="keyword">this</span>.options.handler(result) <span class="keyword">if</span> result?</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Internal recursion method for searching the library.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _get: (obj, klass, context, attributes) -&gt;
    klass = obj.constructor
    bookId = Library._classId(klass)
    contextShelf = <span class="keyword">this</span>.bookcase[bookId]?[context]

    <span class="keyword">if</span> contextShelf?</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>we have a set of possible matches. go through them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">this</span>.handler(record.book) <span class="keyword">for</span> record <span class="keyword">in</span> contextShelf <span class="keyword">when</span> match(record, attributes)

    <span class="keyword">if</span> klass.__super__?
      <span class="keyword">this</span>._get(obj, klass.__super__.constructor, context, attributes)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Class-level internal tracking of object constructors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@classKey</span>: <span class="string">"__janus_classId<span class="subst">#{<span class="keyword">new</span> Date().getTime()}</span>"</span>
  <span class="property">@classMap</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Class-level method for tagging and reading the tag off of constructors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@_classId</span>: (klass) -&gt;
    <span class="keyword">if</span> klass[<span class="keyword">this</span>.classKey]? <span class="keyword">and</span> <span class="keyword">this</span>.classMap[<span class="keyword">this</span>.classKey] <span class="keyword">is</span> klass
      klass[<span class="keyword">this</span>.classKey]
    <span class="keyword">else</span>
      id = util.uniqueId()
      <span class="keyword">this</span>.classMap[id] = klass
      klass[<span class="keyword">this</span>.classKey] = id</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Internal util func for processing a potential match against its advanced
options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">match</span></span> = (record, attributes) -&gt;
  <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> record.options.rejector?(obj) <span class="keyword">isnt</span> <span class="literal">true</span>
  <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> record.options.acceptor? <span class="keyword">and</span> (record.options.acceptor(obj) <span class="keyword">isnt</span> <span class="literal">true</span>)

  isMatch = <span class="literal">true</span>
  util.traverse(attributes, (subpath, value) -&gt; isMatch = <span class="literal">false</span> <span class="keyword">unless</span> util.deepGet(record.options.attributes, subpath) <span class="keyword">is</span> value) <span class="keyword">if</span> attributes

  isMatch</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Export.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.extend module.exports,
  Library: Library</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
