<!DOCTYPE html>

<html>
<head>
  <title>model.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="base.html">
                base.coffee
              </a>
            
              
              <a class="source" href="janus.coffee.html">
                janus.coffee.md
              </a>
            
              
              <a class="source" href="model.html">
                model.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>model.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><strong>Model</strong>s contain primarily a versioned attribute bag, a schema for said bag,
and # eventing around modifications to it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Base = require(<span class="string">'../core/base'</span>)
util = require(<span class="string">'../util/util'</span>)

Null = {} <span class="comment"># sentinel value to record a child-nulled value</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Use Base to get basic methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">extends</span> <span class="title">Base</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We take in an attribute bag and optionally some options for this Model.
Options are for both framework and implementation use; the options the
framework cares about are:
<em> <code>validateOnCreate</code>: Determines whether to validate the attributes given
  with the constructor. Defaults to <em>*true</em></em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (attributes = {}, <span class="property">@options</span> = {}) -&gt;
    <span class="keyword">super</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create our attribute set, and populate the default set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>._attributes = {}
    <span class="keyword">this</span>._attributes.<span class="reserved">default</span> = attributes</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We&#39;ve swallowed the provided attributes whole; do we want to validate
them before proceeding?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.validate() <span class="keyword">unless</span> <span class="keyword">this</span>.options.validateOnCreate <span class="keyword">is</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Override me in implementations to express expected attribute types and
validation methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  schema: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Get an attribute about this model. The key can be a dot-separated path into
a nested plain model. We do not traverse into submodels that have been
inflated.</p>
<p>If we are a shadow copy, we&#39;ll delegate to parent if we find nothing.</p>
<p><strong>Returns</strong> the value of the given key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: (key) -&gt;
    value =
      util.deepGet(<span class="keyword">this</span>._attributes, key) ?
      <span class="keyword">this</span>._parent?.get(key) ?
      <span class="literal">null</span>

    <span class="keyword">if</span> value <span class="keyword">is</span> Null <span class="keyword">then</span> <span class="literal">null</span> <span class="keyword">else</span> value</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Set an attribute about this model. As with get, the first parameter is a
dot-separated string key. The second parameter is the value to set.</p>
<p>Does nothing if the given value is no different from the current.</p>
<p><strong>Returns</strong> the value that was set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: (key, value) -&gt;
    oldValue = util.deepGet(<span class="keyword">this</span>._attributes, key) 
    <span class="keyword">return</span> value <span class="keyword">if</span> oldValue <span class="keyword">is</span> value

    util.deepSet(<span class="keyword">this</span>._attributes, key)(value)

    <span class="keyword">this</span>.emit(<span class="string">"change:<span class="subst">#{key}</span>"</span>, value, oldValue)
    <span class="keyword">this</span>.validate(key)

    value</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Clear the value of some attribute. If we are a shadow copy, we&#39;ll actually
leave behind a sentinel so that we know not to read into our parent.</p>
<p>If the value has changed as a result of this operation, a change event will
be issued.</p>
<p><strong>Returns</strong> the value that was cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unset: (key) -&gt;
    oldValue = <span class="keyword">this</span>.get(key)

    <span class="keyword">if</span> <span class="keyword">this</span>._parent?
      util.deepSet(<span class="keyword">this</span>._attributes, key)(Null)
    <span class="keyword">else</span>
      <span class="keyword">this</span>._deleteAttr(key)

    <span class="keyword">this</span>.emit(<span class="string">"change:<span class="subst">#{key}</span>"</span>, <span class="literal">null</span>, oldValue) <span class="keyword">if</span> oldValue <span class="keyword">isnt</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Revert a particular attribute on this model. After this, the model will
return whatever its parent thinks the attribute should be. If no parent
exists, this function will fail silently. The key can be a dot-separated
path.</p>
<p>If the value has changed as a result of this operation, a change event will
be issued.</p>
<p><strong>Returns</strong> the value that was cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  revert: (key) -&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="keyword">this</span>._parent?
    <span class="keyword">this</span>._deleteAttr(key)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Shadow-copies a model. This allows a second copy of the model to function
as its own model instance and keep a separate set of changes, but which
will fall back on the original model if asked about an attribute it doesn&#39;t
know about.</p>
<p><strong>Returns</strong> a new shadow copy, which is an instance of <code>Model</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  shadow: -&gt;
    shadow = <span class="keyword">new</span> <span class="keyword">this</span>.constructor({}, <span class="keyword">this</span>.options)
    shadow._parent = <span class="keyword">this</span>
    shadow</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Returns the original copy of a model. Returns itself if it&#39;s already an
original model.</p>
<p><strong>Returns</strong> an instance of <code>Model</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  original: -&gt; <span class="keyword">this</span>._parent? ? <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Performs validation of one or all attributes. Returns a <code>ValidationResult</code>
of either <code>Valid</code> or <code>Error</code>, the latter of which contains details about
the infractions.</p>
<p><strong>Returns</strong> a <code>ValidationResult</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validate: (key) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: implement</p>
<p>Helper used by <code>revert()</code> and some paths of <code>unset()</code> to actually clear out
a particular key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _deleteAttr: (key) -&gt;
    util.deepSet(<span class="keyword">this</span>._attributes, key) (obj, subkey) =&gt;
      oldValue = obj[subkey]
      <span class="keyword">delete</span> obj[subkey]

      newValue = <span class="keyword">this</span>.get(key)
      <span class="keyword">this</span>.emit(<span class="string">"change:<span class="subst">#{key}</span>"</span>, newValue, oldValue) <span class="keyword">if</span> newValue <span class="keyword">isnt</span> oldValue

      oldValue</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Export.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.extend(module.exports,
  Model: Model
)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
