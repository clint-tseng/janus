// Generated by CoffeeScript 1.6.2
(function() {
  var Base, Model, Null, NullClass, Varying, from, match, otherwise, util, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  from = require('../core/from');

  _ref = require('../core/case'), match = _ref.match, otherwise = _ref.otherwise;

  Base = require('../core/base').Base;

  Varying = require('../core/varying').Varying;

  util = require('../util/util');

  NullClass = (function() {
    function NullClass() {}

    return NullClass;

  })();

  Null = new NullClass();

  Model = (function(_super) {
    var terminate;

    __extends(Model, _super);

    function Model(attributes, options) {
      if (attributes == null) {
        attributes = {};
      }
      this.options = options != null ? options : {};
      Model.__super__.constructor.call(this);
      this.attributes = {};
      this._attributes = {};
      this._watches = {};
      this._parent = this.options.parent;
      if (typeof this._preinitialize === "function") {
        this._preinitialize();
      }
      this.set(attributes);
      if (typeof this._initialize === "function") {
        this._initialize();
      }
      this._bind();
    }

    Model.prototype.get = function(key, bypassAttribute) {
      var attribute, value, _ref1;

      if (bypassAttribute == null) {
        bypassAttribute = false;
      }
      value = util.deepGet(this.attributes, key);
      if (value == null) {
        value = (_ref1 = this._parent) != null ? _ref1.get(key) : void 0;
        if (value instanceof Model) {
          value = this.set(key, value.shadow());
        }
      }
      value = value === Null ? null : value;
      if ((value == null) && bypassAttribute === false) {
        attribute = this.attribute(key);
        value = attribute != null ? attribute.writeDefault === true ? this.set(key, attribute["default"]()) : attribute["default"]() : void 0;
      }
      return value != null ? value : value = null;
    };

    Model.prototype.set = function() {
      var args, key, obj, oldValue, value,
        _this = this;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      if (args.length === 1 && util.isPlainObject(args[0])) {
        return util.traverse(args[0], function(path, value) {
          return _this.set(path, value);
        });
      } else if (args.length === 2 && util.isPlainObject(args[1])) {
        obj = {};
        util.deepSet(obj, args[0])(args[1]);
        return this.set(obj);
      } else if (args.length === 2) {
        key = args[0], value = args[1];
        oldValue = util.deepGet(this.attributes, key);
        if (oldValue === value) {
          return value;
        }
        util.deepSet(this.attributes, key)(value === Null ? null : value);
        this._emitChange(key, value, oldValue);
        return value;
      }
    };

    Model.prototype.unset = function(key) {
      var oldValue;

      if (this._parent != null) {
        oldValue = this.get(key);
        util.deepSet(this.attributes, key)(Null);
        if (oldValue !== null) {
          this._emitChange(key, this.get(key), oldValue);
        }
      } else {
        oldValue = this.get(key);
        this._deleteAttr(key);
      }
      return oldValue;
    };

    Model.prototype.setAll = function(attrs) {
      var _this = this;

      util.traverseAll(this.attributes, function(path, value) {
        if (util.deepGet(attrs, path) == null) {
          return _this.unset(path.join('.'));
        }
      });
      this.set(attrs);
      return null;
    };

    Model.prototype.watch = function(key) {
      var _base, _ref1,
        _this = this;

      return (_ref1 = (_base = this._watches)[key]) != null ? _ref1 : _base[key] = (function() {
        var varying;

        varying = new Varying(_this.get(key));
        if (_this._parent != null) {
          _this.listenTo(_this._parent, "changed:" + key, function() {
            return varying.set(_this.get(key));
          });
        }
        _this.listenTo(_this, "changed:" + key, function(newValue) {
          return varying.set(newValue);
        });
        return varying;
      })();
    };

    Model.prototype.watchAll = function() {
      var varying,
        _this = this;

      varying = new Varying(this);
      return this.listenTo(this, 'anyChanged', function() {
        return varying.set(_this, true);
      });
    };

    Model.attributes = function() {
      if (this._attributesAgainst !== this) {
        this._attributesAgainst = this;
        this._attributes = {};
      }
      return this._attributes;
    };

    Model.allAttributes = function() {
      var attrs, recurse,
        _this = this;

      attrs = {};
      recurse = function(obj) {
        var attr, key, _ref1;

        if (obj.attributes == null) {
          return;
        }
        if (util.superClass(obj) != null) {
          recurse(util.superClass(obj));
        }
        _ref1 = obj.attributes();
        for (key in _ref1) {
          attr = _ref1[key];
          attrs[key] = attr;
        }
        return null;
      };
      recurse(this);
      return attrs;
    };

    Model.attribute = function(key, attribute) {
      return this.attributes()[key] = attribute;
    };

    Model.prototype.attribute = function(key) {
      var recurse, _base, _ref1,
        _this = this;

      recurse = function(obj) {
        var result, _base;

        if (obj.attributes == null) {
          return;
        }
        result = typeof (_base = (obj.attributes()[key])) === "function" ? new _base(_this, key) : void 0;
        if (result != null) {
          return result;
        } else if (util.superClass(obj) != null) {
          return recurse(util.superClass(obj));
        }
      };
      if (util.isArray(key)) {
        key = key.join('.');
      }
      return (_ref1 = (_base = this._attributes)[key]) != null ? _ref1 : _base[key] = recurse(this.constructor);
    };

    Model.prototype.attributeClass = function(key) {
      return this.constructor.attributes()[key];
    };

    Model.prototype.allAttributes = function() {
      var key, _results;

      _results = [];
      for (key in this.constructor.allAttributes()) {
        _results.push(this.attribute(key));
      }
      return _results;
    };

    Model.binders = function() {
      if (this._bindersAgainst !== this) {
        this._bindersAgainst = this;
        this._binders = [];
      }
      return this._binders;
    };

    Model.bind = function(key, binding) {
      binding._key = key;
      return this.binders().push(binding);
    };

    terminate = function(x) {
      if (x.all != null) {
        return x.all;
      } else {
        return x;
      }
    };

    Model.prototype._bind = function() {
      var recurse,
        _this = this;

      this._binders = {};
      recurse = function(obj) {
        var binder, superClass, _i, _len, _ref1;

        _ref1 = obj.binders();
        for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
          binder = _ref1[_i];
          if (_this._binders[binder._key] == null) {
            (function(binder) {
              var key;

              key = binder._key;
              return _this._binders[key] = terminate(binder).point(function(x) {
                return _this.constructor._point(x, _this);
              }).reactNow(function(value) {
                return _this.set(key, value);
              });
            })(binder);
          }
        }
        superClass = util.superClass(obj);
        if (superClass && (superClass.binders != null)) {
          recurse(superClass);
        }
        return null;
      };
      recurse(this.constructor);
      return null;
    };

    Model._point = match(from["default"].dynamic(function(x, self) {
      if (util.isFunction(x)) {
        return Varying.ly(x(self));
      } else if (util.isString(x)) {
        return self.watch(x);
      } else {
        return Varying.ly(x);
      }
    }), from["default"].attr(function(x, self) {
      return self.watch(x);
    }), from["default"].definition(function(x, self) {
      return new Varying(self.attribute(x));
    }), from["default"].varying(function(x, self) {
      if (util.isFunction(x)) {
        return Varying.ly(x(self));
      } else {
        return Varying.ly(x);
      }
    }), otherwise(function() {
      return x;
    }));

    Model.prototype.revert = function(key) {
      if (this._parent == null) {
        return;
      }
      return this._deleteAttr(key);
    };

    Model.prototype.shadow = function(klass) {
      return new (klass != null ? klass : this.constructor)({}, util.extendNew(this.options, {
        parent: this
      }));
    };

    Model.prototype.modified = function(deep) {
      var result,
        _this = this;

      if (deep == null) {
        deep = true;
      }
      if (this._parent == null) {
        return false;
      }
      result = false;
      util.traverse(this.attributes, function(path) {
        if (_this.attrModified(path, deep)) {
          return result = true;
        }
      });
      return result;
    };

    Model.prototype.attrModified = function(path, deep) {
      var attribute, isDeep, parentValue, transient, value;

      if (this._parent == null) {
        return false;
      }
      value = util.deepGet(this.attributes, path);
      if (value == null) {
        return false;
      }
      if (value === Null) {
        value = null;
      }
      isDeep = deep == null ? true : util.isFunction(deep) ? deep(this, path, value) : deep === true;
      attribute = this.attribute(path);
      transient = (attribute != null) && attribute.transient === true;
      if (!transient) {
        parentValue = this._parent.get(path);
        if (value instanceof Model) {
          return !(__indexOf.call(value.originals(), parentValue) >= 0) || (isDeep === true && value.modified(deep));
        } else {
          return parentValue !== value && !((parentValue == null) && (value == null));
        }
      } else {
        return false;
      }
    };

    Model.prototype.watchModified = function(deep) {
      var isDeep, _ref1, _ref2,
        _this = this;

      isDeep = deep == null ? true : util.isFunction(deep) ? deep(this) : deep === true;
      if (isDeep === true) {
        return (_ref1 = this._watchModifiedDeep$) != null ? _ref1 : this._watchModifiedDeep$ = (function() {
          var model, result, uniqSubmodels, uniqSubvaryings, varying, watchModel, watchVarying, _i, _j, _len, _len1, _ref2, _ref3;

          if (_this._watchModifiedDeep$init === true) {
            return;
          }
          _this._watchModifiedDeep$init = true;
          result = new Varying(_this.modified(deep));
          _this.on('anyChanged', function(path) {
            if (_this.attrModified(path, deep)) {
              return result.set(true);
            } else {
              return result.set(_this.modified(deep));
            }
          });
          watchModel = function(model) {
            return model.watchModified(deep).react(function(isChanged) {
              if (isChanged === true) {
                return result.set(true);
              } else {
                return result.set(_this.modified(deep));
              }
            });
          };
          watchVarying = function(varying) {
            var resolveVarying;

            resolveVarying = function(model) {
              if (model instanceof Model) {
                _this._subvaryings().remove(varying);
                _this._submodels().add(model);
                return varying.off('changed', resolveVarying);
              }
            };
            return varying.react(resolveVarying);
          };
          uniqSubmodels = _this._submodels().uniq();
          uniqSubvaryings = _this._subvaryings().uniq();
          _ref2 = uniqSubmodels.list;
          for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
            model = _ref2[_i];
            watchModel(model);
          }
          _ref3 = uniqSubvaryings.list;
          for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
            varying = _ref3[_j];
            watchVarying(varying);
          }
          uniqSubmodels.on('added', function(newModel) {
            return watchModel(newModel);
          });
          uniqSubmodels.on('removed', function(oldModel) {
            return _this.unlistenTo(oldModel.watchModified(deep));
          });
          uniqSubvaryings.on('added', function(newVarying) {
            return watchVarying(newVarying);
          });
          return result;
        })();
      } else {
        return (_ref2 = this._watchModified$) != null ? _ref2 : this._watchModified$ = (function() {
          var result;

          result = new Varying(_this.modified(deep));
          _this.on('anyChanged', function(path) {
            if (_this.attrModified(path, deep)) {
              return result.set(true);
            } else {
              return result.set(_this.modified(deep));
            }
          });
          return result;
        })();
      }
    };

    Model.prototype.original = function() {
      var _ref1, _ref2;

      return (_ref1 = (_ref2 = this._parent) != null ? _ref2.original() : void 0) != null ? _ref1 : this;
    };

    Model.prototype.originals = function() {
      var cur, _results;

      cur = this;
      _results = [];
      while (cur._parent != null) {
        _results.push(cur = cur._parent);
      }
      return _results;
    };

    Model.prototype.merge = function() {
      var _ref1;

      if ((_ref1 = this._parent) != null) {
        _ref1.set(this.attributes);
      }
      return null;
    };

    Model.prototype.issues = function() {
      var _ref1,
        _this = this;

      return (_ref1 = this.issues$) != null ? _ref1 : this.issues$ = (function() {
        var attr, issueList;

        issueList = (function() {
          var _i, _len, _ref2, _results;

          _ref2 = this.allAttributes();
          _results = [];
          for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
            attr = _ref2[_i];
            if (attr.issues != null) {
              _results.push(attr.issues());
            }
          }
          return _results;
        }).call(_this);
        if (_this._issues != null) {
          issueList.unshift(_this._issues());
        }
        return (new (require('../collection/collection').CattedList)(issueList)).filter(function(issue) {
          return issue.active;
        });
      })();
    };

    Model.prototype.valid = function(severity) {
      if (severity == null) {
        severity = 0;
      }
      return this.issues().filter(function(issue) {
        return issue.severity.map(function(issueSev) {
          return issueSev <= severity;
        });
      }).watchLength().map(function(length) {
        return length === 0;
      });
    };

    Model.deserialize = function(data) {
      var attribute, key, prop, _ref1;

      _ref1 = this.allAttributes();
      for (key in _ref1) {
        attribute = _ref1[key];
        prop = util.deepGet(data, key);
        if (prop != null) {
          util.deepSet(data, key)(attribute.deserialize(prop));
        }
      }
      return new this(data);
    };

    Model.serialize = function(model, opts) {
      var result, walkAttrs,
        _this = this;

      if (opts == null) {
        opts = {};
      }
      walkAttrs = function(keys, src, target) {
        var attribute, innerResult, result, strKey, subKey, thisKey, value, _ref1;

        for (subKey in src) {
          value = src[subKey];
          thisKey = keys.concat([subKey]);
          strKey = thisKey.join('.');
          attribute = model.attribute(strKey);
          result = value === Null ? void 0 : (attribute != null) && (attribute.serialize != null) ? attribute.serialize(opts) : util.isPlainObject(value) ? (innerResult = (_ref1 = target[subKey]) != null ? _ref1 : {}, walkAttrs(thisKey, value, innerResult), innerResult) : value;
          target[subKey] = result;
        }
        return target;
      };
      result = model._parent != null ? Model.serialize(model._parent, opts) : {};
      walkAttrs([], model.attributes, result);
      return result;
    };

    Model.prototype.serialize = function() {
      return this.constructor.serialize(this);
    };

    Model.prototype._deleteAttr = function(key) {
      var newValue, oldValue;

      oldValue = util.deepDelete(this.attributes, key);
      newValue = this.get(key);
      if (newValue !== oldValue) {
        this._emitChange(key, newValue, oldValue);
      }
      return oldValue;
    };

    Model.prototype._emitChange = function(key, newValue, oldValue) {
      var emit, parts,
        _this = this;

      parts = util.isArray(key) ? key : key.split('.');
      if (oldValue instanceof Model) {
        this._submodels().remove(oldValue);
      }
      if (newValue instanceof Model) {
        this._submodels().add(newValue);
      }
      if (oldValue instanceof Varying) {
        this._subvaryings().remove(oldValue);
      }
      if (newValue instanceof Varying) {
        this._subvaryings().add(newValue);
      }
      emit = function(name, partKey) {
        return _this.emit("" + name + ":" + partKey, newValue, oldValue, partKey);
      };
      emit('changed', parts.join('.'));
      while (parts.length > 1) {
        parts.pop();
        emit('subKeyChanged', parts.join('.'));
      }
      this.emit('anyChanged', key, newValue, oldValue);
      return null;
    };

    Model.prototype._submodels = function() {
      var _ref1;

      return (_ref1 = this._submodels$) != null ? _ref1 : this._submodels$ = new (require('../collection/list').List)();
    };

    Model.prototype._subvaryings = function() {
      var _ref1;

      return (_ref1 = this._subvaryings$) != null ? _ref1 : this._subvaryings$ = new (require('../collection/list').List)();
    };

    return Model;

  })(Base);

  util.extend(module.exports, {
    Model: Model
  });

}).call(this);
