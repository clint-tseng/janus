// Generated by CoffeeScript 1.12.2
(function() {
  var List, NavigateOne, Navigator, NavigatorRoot, Varying, closest, identity, into, isKey, isNumber, isString, match, parentQ, ref,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  Varying = require('../core/varying').Varying;

  List = require('../collection/list').List;

  ref = require('../util/util'), identity = ref.identity, isString = ref.isString, isNumber = ref.isNumber;

  match = function(selector, view) {
    if (void 0 === selector) {
      return true;
    } else if (view === selector) {
      return true;
    } else if ((view != null ? view.subject : void 0) === selector) {
      return true;
    } else if (selector[Symbol.hasInstance] != null) {
      if (view instanceof selector) {
        return true;
      } else if ((view != null ? view.subject : void 0) instanceof selector) {
        return true;
      }
    }
  };

  isKey = function(x) {
    return isString(x) || isNumber(x);
  };

  into = function(selector) {
    return function(selection, primitive) {
      var binding, i, j, k, len, len1, len2, localSelector, obs, ref1, ref2, ref3, ref4, results, selected, selectorIsKey, view;
      selectorIsKey = isKey(selector);
      if (primitive === true) {
        results = [];
        for (i = 0, len = selection.length; i < len; i++) {
          selected = selection[i];
          localSelector = selectorIsKey ? (ref1 = (ref2 = selected.subject) != null ? ref2.get_(selector) : void 0) != null ? ref1 : selector : selector;
          if (selected._bindings != null) {
            ref3 = selected._bindings;
            for (j = 0, len1 = ref3.length; j < len1; j++) {
              binding = ref3[j];
              if (!(binding.view != null)) {
                continue;
              }
              view = binding.view.get();
              if ((view != null) && match(localSelector, view) === true) {
                results.push(view);
              }
            }
          } else if (selected._mappedBindings != null) {
            ref4 = selected._mappedBindings.list;
            for (k = 0, len2 = ref4.length; k < len2; k++) {
              obs = ref4[k];
              view = obs.parent.get();
              if ((view != null) && match(localSelector, view) === true) {
                results.push(view);
              }
            }
          }
        }
        return results;
      } else {
        return selection.map(function(selected) {
          var ref5, subviews;
          localSelector = Varying.of(selectorIsKey ? (ref5 = selected.subject) != null ? ref5.get(selector) : void 0 : selector);
          subviews = selected._bindings != null ? new List((function() {
            var l, len3, ref6, results1;
            ref6 = selected._bindings;
            results1 = [];
            for (l = 0, len3 = ref6.length; l < len3; l++) {
              binding = ref6[l];
              if (binding.view != null) {
                results1.push(binding.view);
              }
            }
            return results1;
          })()) : selected._mappedBindings != null ? selected._mappedBindings.flatMap(function(binding) {
            return binding.parent;
          }) : void 0;
          return subviews.flatMap(identity).filter(function(view) {
            if (view == null) {
              return false;
            } else {
              return localSelector.map(function(s) {
                return match(s, view);
              });
            }
          });
        }).flatten();
      }
    };
  };

  parentQ = function(selector) {
    return function(selection, primitive) {
      var i, len, parent, results, selected;
      if (primitive === true) {
        results = [];
        for (i = 0, len = selection.length; i < len; i++) {
          selected = selection[i];
          parent = selected.options.parent;
          if ((parent != null) && match(selector, parent) === true && (results.indexOf(parent) === -1)) {
            results.push(parent);
          }
        }
        return results;
      } else {
        return selection.map(function(selected) {
          return selected.options.parent;
        }).filter(function(parent) {
          return (parent != null) && match(selector, parent);
        }).uniq();
      }
    };
  };

  closest = function(selector) {
    return function(selection, primitive) {
      var i, len, parent, results, selected;
      if (primitive === true) {
        results = [];
        for (i = 0, len = selection.length; i < len; i++) {
          selected = selection[i];
          parent = selected.options.parent;
          while (parent != null) {
            if (match(selector, parent) === true) {
              if (results.indexOf(parent) === -1) {
                results.push(parent);
              }
              parent = null;
            } else {
              parent = parent.options.parent;
            }
          }
        }
        return results;
      } else {
        return selection.map(function(view) {
          parent = view.options.parent;
          while (parent != null) {
            if (match(selector, parent) === true) {
              return parent;
            }
            parent = parent.options.parent;
          }
        }).filter(function(x) {
          return x != null;
        }).uniq();
      }
    };
  };

  Navigator = (function() {
    function Navigator(precedent, op) {
      this.precedent = precedent;
      this.op = op;
    }

    Navigator.prototype.parent = function(selector) {
      return new Navigator(this, parentQ(selector));
    };

    Navigator.prototype.into = function(selector) {
      return new Navigator(this, into(selector));
    };

    Navigator.prototype.closest = function(selector) {
      return new Navigator(this, closest(selector));
    };

    Navigator.prototype.first = function() {
      return new NavigateOne(this, 0);
    };

    Navigator.prototype.last = function() {
      return new NavigateOne(this, -1);
    };

    Navigator.prototype.get_ = function() {
      return this.op(this.precedent._get(true), true);
    };

    Navigator.prototype.get = function() {
      return this.op(this.precedent._get(false), false);
    };

    Navigator.prototype._get = function(primitive) {
      return this.op(this.precedent._get(primitive), primitive);
    };

    return Navigator;

  })();

  NavigateOne = (function(superClass) {
    extend(NavigateOne, superClass);

    function NavigateOne(precedent, idx1) {
      this.precedent = precedent;
      this.idx = idx1;
    }

    NavigateOne.prototype.get_ = function() {
      var idx, selection;
      selection = this.precedent._get(true);
      idx = this.idx < 0 ? selection.length + this.idx : this.idx;
      return selection[idx];
    };

    NavigateOne.prototype.get = function() {
      return this.precedent._get(false).at(this.idx);
    };

    NavigateOne.prototype._get = function(primitive) {
      var result;
      if (primitive === true) {
        if ((result = this.get_()) != null) {
          return [result];
        } else {
          return [];
        }
      } else {
        result = this.get();
        return (new List([null])).flatMap(function() {
          return result;
        }).filter(function(x) {
          return x != null;
        });
      }
    };

    return NavigateOne;

  })(Navigator);

  NavigatorRoot = (function(superClass) {
    extend(NavigatorRoot, superClass);

    function NavigatorRoot(selection1) {
      this.selection = selection1;
    }

    NavigatorRoot.prototype.get_ = function() {
      return [this.selection];
    };

    NavigatorRoot.prototype.get = function() {
      return new List(this.selection);
    };

    NavigatorRoot.prototype._get = function(primitive) {
      if (primitive === true) {
        return this.get_();
      } else {
        return this.get();
      }
    };

    return NavigatorRoot;

  })(Navigator);

  module.exports = {
    Navigator: Navigator,
    NavigatorRoot: NavigatorRoot,
    match: match
  };

}).call(this);
